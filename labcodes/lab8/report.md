# Lab 8

## 知识点

这些是与本实验有关的原理课的知识点：

* 管道
* 虚拟文件系统框架
* 文件描述符
* 目录等
* inode、打开的文件等结构体
* inode缓存

此外，本实验还涉及如下知识点：

* 简单文件系统
* ucore文件系统架构

遗憾的是，如下知识点在原理课中很重要，但本次实验没有很好的对应：

* 其他进程间通信机制，例如信号、消息队列和共享内存
* RAID
* 磁盘调度算法
* 磁盘缓存

## 练习0

首先，需要对之前的代码进行微小的修改：

1. `alloc_proc`加入对新增字段的初始化，由于我使用`memset`初始化，不需要修改
2. `do_fork`中，使用`copy_files`复制进程打开的文件

## 练习1

这个练习需要实现SFS文件系统层的`sfs_io_nolock`函数。实现过程中，需要用到以下辅助函数或函数指针：

* `sfs_bmap_load_nolock`：根据相对于文件而言的块号，获得inode号。
* `sfs_buf_op`：带缓冲区的块操作，可以用来进行对齐或非对齐的块读写操作；但是，对齐的操作不用此函数，否则会有多余的拷贝操作。根据读写操作的不同，分别指向`sfs_wbuf`或`sfs_rbuf`。
* `sfs_block_op`：直接的块操作，可以用来进行对齐的块读写操作。根据读写操作的不同，分别指向`sfs_wblock`或`sfs_rblock`。

根据需要实现的`sfs_io_nolock`函数的输入参数，可以计算出读写文件操作的开始和结束位置，它们可能是没有按照块大小对齐的，为此需要特殊处理。我的处理方案分两大类情况：

*第一类情况*

开始和结束位置有一个没有对齐，并且开始和结束在同一块内。

对于这种情况，只须调用`sfs_bmap_load_nolock`得到块号，然后使用`sfs_buf_op`完成非对齐的操作。

*第二类情况*

不是上述情况的其他情况，例如开始和结束位置不在同一块。

可以将开始到结束的区间分为三段：

1. 首部非对齐的部分
2. 中间对齐的部分
3. 尾部非对齐的部分

对于首部非对齐的部分以及尾部非对齐的部分，处理方法类似于第一类情况。

对于中间对齐的部分，对于其中每一个块，调用`sfs_bmap_load_nolock`得到块号后直接调用`sfs_block_op`完成对齐的操作。注意，虽然`sfs_block_op`支持一次操作多个块，但这里对于文件的操作不能一次调用`sfs_block_op`完成所有块的操作，因为相对于文件连续的块不一定在下层存储设备上连续，即块号不一定连续，故对于每一个块需要重新调用`sfs_bmap_load_nolock`得到块号。

注意，实现时还需要考虑出错处理。

### 管道机制的设计

**创建**

首先，是管道的创建，即`pipe`系统调用的实现。

为创建管道，可以先创建一个类型为管道的inode，操作虚表配置为如下说明的读写操作，同时要为管道准备好缓冲区。然后，创建两个“打开的文件”结构体（`file`结构体）和相应的文件描述符，一个设置为只读，另外一个设置为只写，都绑定到此inode。最后，把这两个文件描述符返回给用户。一种实现是用户提供一个数组，内核填写为两个文件描述符。

**读**



**写**



顺便一提，管道的实现和stdin设备的实现非常类似。

## 练习2



### 硬链接机制的设计

硬链接的设计非常简单，只需要创建时将目录项的名字设定为指定的名字，目录项的inode号设置为目标文件或目录等的inode号即可。此外，还需要增加目标inode的引用计数。

删除时，同样需要减少目标inode的引用计数，归零后，清除目标inode及其数据块。

其他操作均不需要变化。

### 软链接机制的设计

软链接也叫做符号链接，实际上就是一类特殊类型的文件，文件的数据为指向的目标文件或目录等的路径。

创建时，只需将类型设置为符号链接，文件内容（数据）设置为目标路径字符串。

删除操作和普通文件实现一致。

此外，在各类`lookup`操作时要考虑软链接的作用，需要真正处理软链接的目标而不是软链接本身。