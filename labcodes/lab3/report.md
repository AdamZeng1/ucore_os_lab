# Lab 3

## 知识点

这些是与本实验有关的原理课的知识点：

* 先进先出替换算法：原理课注重原理，本实验注重实现
* 扩展时钟替换算法：原理课注重原理，本实验注重实现

此外，本实验还涉及如下知识点：

无

遗憾的是，如下知识点在原理课中很重要，但本次实验没有很好的对应：

* 其他局部页替换算法
* 全局页替换算法
* Belady现象
* 抖动和负载控制

## 练习1

这个练习提供的注释已经写得非常详细，比实际要写的代码还要多，根据它写出C代码即可。

主要就是在页错误异常处理程序中，当`mm`结构体拥有此虚拟地址但页表中还没有映射时，调用`pgdir_alloc_page`来分配并映射一个物理页面。这其实是按需分配的实现。

页目录项和页表项的字段在Lab 2实验报告中已做说明，这里重点说明对实现页替换算法有重要作用的字段。

主要使用页表项的字段。页表项的字段和页目录项十分类似：

```
 31               12 11 9 8 7 6 5 4 3 2 1 0
+-------------------+----+-+-+-+-+-+-+-+-+-+
|   页基地址高20位   |忽略|G|0|D|A|C|T|U|W|P|
+-------------------+----+-+-+-+-+-+-+-+-+-+
```

与页替换算法有关的字段有：

- A：在上次清零之后，该页是否被访问（读或者写）过，可用于时钟替换算法和扩展时钟替换算法的实现
- D：在上次清零之后，该页是否被写过，可用于扩展时钟替换算法的实现
- P：页面是否存在于内存中，当此位清零时，其余位都可供内核自由使用。这可以用来存放交换分区的一些信息，可用于各种页替换算法的实现。

如果ucore的页错误处理程序执行过程中访问内存，又出现了页错误异常，由于这个异常不可以屏蔽，处理器会将异常的线性地址保存在CR2寄存器中，然后查询IDT找到中断服务程序入口点。由于当前已在内核态，不涉及特权级的变化，处理器还会向当前栈中压入cs、eip和错误码。错误码记录了异常的一些标志，比如是读还是写操作触发了异常，是非法访问还是缺页触发了异常，这对于页替换算法和写时复制的实现都有用。最后，跳转至中断服务程序。这些事情中间还会做权限检查，不通过还会触发保护错误。这些事情执行的顺序可能与处理器实现有关。

与参考答案对比，我缺少了对于出错情况检查的代码，应修复。

## 练习2

这个练习提供的注释已经写得非常详细，比实际要写的代码还要多，根据它写出C代码即可。

在成功分配一个物理页面的时候将此页面插入物理页面链表尾；当需要选择一个页面被换出时，选择链表头的页面返回。这就实现了先进先出替换算法。

此外，若某页面已分配但还是产生了异常，说明此页面被换出了。此时，缺页异常处理程序需要选择一个页面换出，然后将触发缺页异常的页面换入并修改页表映射。还要设置好`Page`结构体的`pra_vaddr`，此字段说明了该物理页面对应的虚拟地址，在换出时用于计算该页面应写入交换分区的位置。

与参考答案对比，我缺少了对于出错情况检查的代码，应修复。

## 扩展练习 - 扩展时钟替换算法

